#!/bin/bash


# (to be improved)
# 
# Huanle Zhang
# www.huanlezhang.com

recordId=0
savePath=/dtc

serverIp=192.172.1.1
serverPort=50000

clientIp=192.172.1.192
clientPort=50000

queueSize=100000
sendLength=2000

debugfsPath=/sys/kernel/debug
dtcSockDir=${debugfsPath}/dtcSock
dtcMacDir=${debugfsPath}/dtcMac
dtcAthDir=${debugfsPath}/dtcAth


usage(){
cat <<EOF
Usage: program -[r|l|s]
	-r	run sender tools
	-l	listen only 
	-s	stop tools, and save data to files
Example: program -r
			trigger sender program
		 program -s
			stop program 
EOF
}

readId(){
	
	if [ -f /root/autoId ]; then
		recordId=$(cat /root/autoId) 
	fi 
}

updateId(){

	if [ -f /root/autoId ]; then 
		recordId=$(( $recordId + 1 ))
		echo $recordId > /root/autoId 
	fi 
}

# starts from here --------
if [ $# -ne 1 ]; then 
	echo "**** Error"
	usage
	exit
fi

readId 

while getopts ":rls" opt; do
	case $opt in
	r) # run
        dtcKillProgram dtc_udp_redundant_txrx
        sleep 2 # wait for server
		date > $savePath/ReadMe$recordId 
		myRunCmd="dtcDebugfsController -s uma -i $serverIp -p $serverPort -c enable"
		# echo $myRunCmd >> $savePath/ReadMe$recordId 
		eval $myRunCmd

        dtc_udp_redundant_txrx --client \
            --target-address $serverIp $serverPort \
            --self-address 0.0.0.0 $clientPort \
            --send-fatest \
            --queue-size $queueSize \
            --send-length $sendLength \
            --record-directory $savePath --record-id $recordId \
            --send-log --recv-log 

		echo "Running..."
		;;
	l) # listen only
        dtcKillProgram dtc_udp_redundant_txrx 
		date > $savePath/ReadMe$recordId 

        dtc_udp_redundant_txrx --server \
            --self-address $serverIp $serverPort \
            --record-directory $savePath --record-id $recordId \
            --queue-size $queueSize \
            --send-log --recv-log \
            --echo-back 

		myListenCmd="dtcDebugfsController -i $clientIp -p $clientPort -c enable"
		# echo $myListenCmd >> $savePath/ReadMe$recordId 
		eval $myListenCmd 
		echo "Listening..."
		;;
	s) # stop and save data
		dtcDebugfsController -c disable
		date >> $savePath/ReadMe$recordId 
		ps | grep dtc_udp_redundant_txrx | grep -v grep | awk '{print $1}' | xargs -r kill -9
		# modify to your needs
		cat ${dtcSockDir}/log1 > ${savePath}/sockLog1_${recordId}
		cat ${dtcSockDir}/log2 > ${savePath}/sockLog2_${recordId}
		cat ${dtcMacDir}/log1 > ${savePath}/macLog1_${recordId}
		cat ${dtcMacDir}/log2 > ${savePath}/macLog2_${recordId}
		cat ${dtcAthDir}/log1 > ${savePath}/athLog1_${recordId}
		cat ${dtcAthDir}/log2 > ${savePath}/athLog2_${recordId}
		
		updateId 
		echo "Save file done"
		;;
	\?) # error
		echo "**** Error"
		echo "unknown option"
		exit
		;;
	esac 
done
shift $(($OPTIND - 1))
