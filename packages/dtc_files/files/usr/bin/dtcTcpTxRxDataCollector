#!/bin/bash

# data collector for dtc_tcp_txrx
#   specify server of client
#
# Huanle Zhang at UC Davis
# www.huanlezhang.com


server_ip=192.168.21.1
server_port=50000

send_interval=100000000
send_length=508

record_directory=/dtc
record_id_path=/root/autoId
record_id=0

argumentProcess (){
 
    if [ $# -ne 1 ]; then
        echo "Usage: dtcTcpTxRxDataCollector"
        echo "      --server|--client|--stop"
        exit
    fi 

    readId 

    while [[ $# -gt 0 ]]; do
        key="$1"
        case $key in
            --server) # server
                dtcKillProgram dtc_tcp_txrx
                echo "start dtc_tcp_txrx server"
                date > ${record_directory}/dtc_tcp_txrx_README_${record_id}
                myCmd="dtc_tcp_txrx --server \
                    --self-address ${server_ip} ${server_port} \
                    --send-log --recv-log --print-packet --echo-back \
                    --record-directory ${record_directory} \
                    --record-id ${record_id}"
                echo $myCmd >> ${record_directory}/dtc_tcp_txrx_README_${record_id}
                eval $myCmd 
                shift
                ;;
            --client) # client
                dtcKillProgram dtc_tcp_txrx
                echo "start dtc_tcp_txrx client"
                sleep 10  # client wait for server
                date > ${record_directory}/dtc_tcp_txrx_README_${record_id}
                myCmd="dtc_tcp_txrx --client \
                    --target-address ${server_ip} ${server_port} \
                    --send-log --recv-log --print-packet \
                    --send-interval ${send_interval} \
                    --record-directory ${record_directory} \
                    --record-id ${record_id} \
                    --send-length ${send_length}"
                echo $myCmd >> ${record_directory}/dtc_tcp_txrx_README_${record_id}
                eval $myCmd 
                shift
                ;;
            --stop) # stop
                dtcKillProgram dtc_tcp_txrx
                echo "stop dtc_tcp_txrx"
                date >> ${record_directory}/dtc_tcp_txrx_README_${record_id}
                updateId
                shift 
                ;;
            *) # unknown arguments
                echo "***Error unknown argument"
                echo "\t $1"
                exit
            ;;
        esac
    done
}

readId (){
    if [ -f ${record_id_path} ]; then
        record_id=$(cat ${record_id_path})
    fi
}

updateId (){
    if [ -f ${record_id_path} ]; then
        record_id=$(( $record_id + 1 ))
        echo $record_id > ${record_id_path}
    fi
}

# ------ main starts
argumentProcess $@

